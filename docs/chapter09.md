# 9. マルチスレッド

SynchronizedStatement:
    synchronized ( Expression ) Block

## マルチスレッドと同期化

Java のプログラムは、内部的にはスレッドという単位に分割され、複数のスレッドを同時に実行することができます。これを「マルチスレッド」と呼んでいます。もっとも小さな Java プログラムは 1 つのスレッドだけで構成されますが、待ち時間を要するプログラムでは、時間のかかる処理を別個のスレッドで実行し、プログラムの中核をなすスレッド (メインのスレッド) が無応答になる状態を防ぐテクニックが用いられます。マルチスレッドの環境では、スレッド = 処理 (1 本のフローチャートに対応すると考えてください) が複数存在し、メモリなどのリソースをすべてのスレッドで共有することになります。

- ネットワーク・アクセスを伴うプログラムでは、ローカルのファイルシステムにアクセスするプログラムと比較して、処理が完了するまでに長い時間がかかります。これを 1 つのスレッドだけで処理しようとすると、ネットワーク・アクセスを開始してから終了するまでの間プログラムが応答しない状態となり、プログラムを実行する側からはプログラムが動いているのかわからないように見えます。ネットワーク・アクセスを行う処理を別のスレッドで実行し、メインのスレッドはネットワーク・アクセス開始後すぐに応答するようにプログラミングすると、そのような状態を回避することができます (別途、ネットワーク・アクセスを行うスレッドが処理を完了した通知をメインのスレッドに行う必要はあります)。
- GUI を持つプログラムでは、ボタンなどのイベント処理をメインとは別のスレッドで行うことが多くあります (Visual Basic などでは意識しない点です)。もしイベント処理までメインのスレッドで実行すると、処理に時間を要するイベントを発行した直後に GUI 全体がフリーズします。これは、GUI のその他の部品 (ウィンドウなど) が自然に振る舞うために必要なパワーをすべて特定のイベント処理に割かれてしまうためです。イベント処理 (特に時間のかかるもの) を別のスレッドで実行することで、GUI 全体がフリーズすることを回避できます。
- サーバー・プログラミングにおいては、クライアントからのリクエストを待ち受ける部分や、リクエストを処理する部分をマルチスレッドで構築し、複数のクライアントからのアクセスに耐えられるようにするのが一般的です。もしサーバーをメインのスレッドだけで構築しようとすると、リクエストが来るまでプログラムが応答しない、応答できるリクエストは 1 つだけ、リクエスト処理中に別のリクエストが来た場合にはエラーではなく無応答となる、などとても実用に耐える代物ではなくなってしまいます。サーバー・プログラミングに関しては、マルチスレッドの代わりにマルチプロセス (複数のプログラムを同時に実行する) でも実現可能ですが、オーバーヘッドが非常に大きくなります。

マルチスレッドの環境では、同じインスタンスのメソッドやフィールドが同時に複数のスレッドからアクセスされる場合があります。Java のメソッド自体は複数のスレッドから呼び出される前提になっていますが、メソッドから呼び出されるフィールドは同時アクセスに対して非常に脆弱で、予期しない値が設定されてしまうことも少なからずあります。そこで、マルチスレッドの環境ではメソッドやフィールドへのアクセスの交通整理を行い、値が想定通りに設定されることを保証する必要があります。これを「同期化」といいます。

文字列を表す `String` クラスや日付を表す `LocalDate` クラスなどの、いわゆるイミュータブルなクラスは、初期化後に値が再設定されることがないため、同期化をしなくても内部のフィールドの状態は保たれます。このようなクラスを「スレッドセーフ」なクラスと呼びます。イミュータブルなクラスはすべてスレッドセーフであり、一部のミュータブル（イミュータブルでない）クラスも同期化されていればスレッドセーフです。ただし、ミュータブルなクラスの同期化はコストがかかるため、基本的には同期化されない状態で提供され、必要に応じて同期化するテクニックが用いられます (メソッド内でのみ使用する場合には、同一スレッドで実行されることが保証されるため、同期化の必要がありません)。

最近の流れとして、クラスをイミュータブルな設計にして同期化を避ける傾向があります。クラスを完璧に同期化することは熟練の Java プログラマにとっても難しい課題であり、回避する方法があるのならばそれを採りたいからです。

マルチスレッドは、GUI プログラミングでは具体的な実装方法まで理解しておく必要があります。一方、Java EE では実行環境がマルチスレッドで実装されていることを押さえておくだけで十分です。Java EE ではスレッドの管理を実行環境が掌握しているため、アプリケーションをマルチスレッドで実行することは原則として禁止されています。